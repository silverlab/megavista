function dtiMakeBrainMaskSafe(dtiDir, dtiRawDir)%E.g., dtiMakeBrainSafeMask('dti06rt', 'raw')%Take brainMask.nii.gz and remove the voxels that have a zero in the raw data (at%least in one gradient directions)%Input: directory with raw dti data%Will overwrite your brainMask.nii.gz with a new safer one.%ER 02/23/2009 pulled code out of mtrNotes to perform this operationdirPrev = pwd;cd(dtiRawDir);% Avg the raw file down to independent partsni = readFileNifti('dti_g13_b800_aligned.nii.gz');bvals = load('dti_g13_b800_aligned.bvals','-ascii');bvecs = load('dti_g13_b800_aligned.bvecs','-ascii');ni.fname = 'dti_g13_b800_aligned_avg.nii.gz';nD = 13;%avg_bvals = bvals(1:nD);avg_bvecs = bvecs(:,1:nD);ndata = ni.data(:,:,:,1:nD);for ii=1:nD    avg_bvecs(:,ii) = mean(bvecs(:,ii:nD:end),2);    ndata(:,:,:,ii) = mean(ni.data(:,:,:,ii:nD:end),4);endni.data = ndata;% Update brain mask so that bad voxels are removedcd([dtiDir filesep 'bin']);bm = readFileNifti('brainMask.nii.gz');rawm = min(ndata,[],4);bm.data(rawm<1) = 0;%bm.fname='brainMaskRawSafe.nii.gz';writeFileNifti(bm);cd(dirPrev);return;